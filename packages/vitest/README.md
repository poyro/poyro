# @poyro/vitest

[![npm version](https://badge.fury.io/js/%40poyro%2Fvitest.svg)](https://badge.fury.io/js/%40poyro%2Fvitest) | [![Discord](https://img.shields.io/discord/898588993311031818?color=5865F2&label=discord&logo=discord&logoColor=white)](https://discord.gg/xcQWXeyk)

This package contains Poyro bindings for the [Vitest](https://github.com/vitest-dev/vitest) test framework.

## Prerequisites

- Node.js 20 or later
- Vitest 1.6.0 or later
- Your project must have "type": "module" in its package.json (this library is ESM only)
- Recommended: CUDA-compatible GPU (Nvidia) or Metal-compatible GPU (Apple Silicon) for best performance, but not required

## Installation

To install the package, run the following command:

If you're using npm:

```bash
npm install --save-dev @poyro/vitest
```

If you're using yarn:

```bash
yarn add --dev @poyro/vitest
```

If you're using pnpm:

```bash
pnpm install --save-dev @poyro/vitest
```

### Automatic Installation

WIP

### Manual Installation

Once installed, you will need to configure Vitest to use the Poyro bindings. To do this, create a `vitest.setup.js` file in the root of your project and add the following code:

```javascript
import "@poyro/vitest";
```

Once you have done this, update create or update `vitest.config.js` to include the following (if you didn't previously have a setup file):

```javascript
import { defineConfig } from "vitest/config";

export default defineConfig({
  test: {
    setupFiles: ["vitest.setup.js"],
  },
});
```

Next, create a `vitest.d.ts` file in the root of your project and add the following code:

```typescript
import type { Assertion, AsymmetricMatchersContaining } from "vitest";
import { VitestPoyroMatchers } from "@poyro/vitest";

declare module "vitest" {
  interface Assertion<T = any> extends VitestPoyroMatchers<T> {}
  interface AsymmetricMatchersContaining extends VitestPoyroMatchers {}
}
```

Finally, update your `tsconfig.json` to include the following:

```json
{
  "compilerOptions": {
    "types": ["vitest.d.ts"]
  }
}
```

You're now all set to include Poyro matchers in your tests!

## Usage

To use the matchers, simply use them as you would any other matcher in Vitest! For example:

```typescript
it("should be true", async () => {
  // This is some output generated by an LLM, the way you get it
  // is totally up to you
  const llmOutput = "Hello, world!";

  await expect(llmOutput).toFulfillCriterion("Says hello");
}, 15000);
```

Behind the scenes, the `toFulfillCriterion` matcher will evaluate the output against the criterion and provide feedback based on the result using a local LLM supplied by `@poyro/vitest`.

> **Note:** Depending on the complexity of the criterion as well as the output, the matching process may take some time. If the tests timeout before the matcher can complete, you can increase the timeout in the third argument of the `it`/`test` function or inside `vitest.config.js`.

## Troubleshooting

### `libc++abi: terminating due to uncaught exception of type Napi::Error:`

There can be many reasons for this error, below are a few common reasons why it may happen.

#### Test timeout exceeded

One common cause is that your timeout is too low. Try increasing the timeout in the third argument of the `it`/`test` function or inside `vitest.config.js`. Additionally, ensure that you `await` the matcher call, as it is asynchronous.

#### Out of memory

If you're running on a machine with limited memory, you may run out of memory during the test. Try closing other memory-intensive processes or running the test on a machine with more memory.

Additionally, you may also receive this error if you attempt to parallelize test with a `Promise.all` or similar construct. Each of these tests will spawn a new instance of the LLM, which can quickly consume memory. In such instances, it is recommended to run the tests serially.

#### Other issues

If none of these solves your issue, please get in touch with us on the [Poyro Discord](https://discord.gg/xcQWXeyk) for further assistance.
